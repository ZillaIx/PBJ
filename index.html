<!DOCTYPE html>
<html>
<head>
    <title>Peanut Butter $Jelly Time!</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style>
        body {
            /* Changed to a gradient to make the black bars less noticeable */
            background: linear-gradient(to bottom, #1d003b, #000000);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            font-family: Arial, sans-serif;
            flex-direction: column;
        }

        /* The game container will now manage the full-screen layout */
        #game-container {
            width: 100%;
            height: 100%;
            /*max-width: 720px;*/
            /*max-height: 1280px;*/
            position: relative;
        }

        #username-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        #username-input {
            padding: 23px; /* Increased padding by 1.5x */
            border: 2px solid white;
            background-color: rgba(255, 255, 255, 0.2); /* Semi-transparent white background */
            color: white;
            font-size: 42px; /* Increased font size by 1.5x */
            text-align: center;
            margin-bottom: 38px; /* Increased margin by 1.5x */
            font-weight: bold;
        }

        #ready-button {
            padding: 23px 45px; /* Increased padding by 1.5x */
            font-size: 42px; /* Increased font size by 1.5x */
            background-color: #ffd700; /* Brighter gold color */
            color: black; /* Black text for contrast */
            border: none;
            cursor: pointer;
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); /* Drop shadow for depth */
            font-weight: bold;
        }
    </style>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Global variables for Firebase
        window.app = null;
        window.db = null;
        window.auth = null;

        // Your web app's Firebase configuration
        // You can copy and paste this directly from your Firebase project settings
        window.firebaseConfig = {
          apiKey: "AIzaSyCLoQQc6x0PjMH4TbUZEsRv_Z6l4ubaj3k",
          authDomain: "pbjelly-1db51.firebaseapp.com",
          projectId: "pbjelly-1db51",
          storageBucket: "pbjelly-1db51.firebase-storage.app",
          messagingSenderId: "238324604340",
          appId: "1:238324604340:web:dd8d647bf3b7efcdcb26e1",
          measurementId: "G-FY4HEE1P6D"
        };
        
        // Expose Firebase functions to the global scope for the Phaser scenes to use
        window.initializeFirebase = async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                let firebaseConfig = null;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // Use the environment variable if available, otherwise use the hardcoded config
                if (typeof __firebase_config !== 'undefined' && __firebase_config !== '') {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else if (typeof window.firebaseConfig !== 'undefined') {
                    firebaseConfig = window.firebaseConfig;
                } else {
                    console.error("Firebase initialization failed: API key is missing or invalid. Please check the code for instructions.");
                    return;
                }
                
                // Set Firestore log level to debug
                setLogLevel('debug');
                
                // Initialize Firebase app and services
                if (firebaseConfig && firebaseConfig.apiKey) {
                    window.app = initializeApp(firebaseConfig);
                    window.auth = getAuth(window.app);
                    window.db = getFirestore(window.app);

                    // Authenticate the user
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                    
                    // Get the user ID
                    window.userId = window.auth.currentUser?.uid || crypto.randomUUID();

                    console.log("Firebase initialized successfully. User authenticated.");
                } else {
                    console.error("Firebase initialization failed: API key is missing or invalid. Please check the code for instructions.");
                }

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
            }
        };

        window.savePublicScore = async (username, score) => {
            if (!window.db) {
                console.error("Firestore not initialized.");
                return;
            }
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const highscoresCollectionRef = collection(window.db, `artifacts/${appId}/public/data/highscores`);
                await addDoc(highscoresCollectionRef, { username, score, timestamp: new Date() });
                console.log("Score saved successfully!");
            } catch (error) {
                console.error("Error saving score:", error);
            }
        };

        window.getPublicHighScores = (callback) => {
            if (!window.db) {
                console.error("Firestore not initialized.");
                return;
            }
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const highscoresCollectionRef = collection(window.db, `artifacts/${appId}/public/data/highscores`);
                const q = query(highscoresCollectionRef);

                // Use onSnapshot for real-time updates
                onSnapshot(q, (querySnapshot) => {
                    const scores = [];
                    querySnapshot.forEach((doc) => {
                        scores.push(doc.data());
                    });
                    
                    // Add this line to log the scores to the console
                    console.log("Fetched scores:", scores);

                    // Sort scores in-memory as per instructions
                    scores.sort((a, b) => b.score - a.score);
                    callback(scores);
                }, (error) => {
                    console.error("Error fetching high scores:", error);
                });
            } catch (error) {
                console.error("Error setting up high scores listener:", error);
            }
        };
    </script>
</head>
<body>
    <div id="game-container"></div>
    <div id="username-container"></div>
    <script>
        // Global variables for the game state
        let highscores = [];
        let username = '';
        let music, feverSound;
        let goodSound, badSound;
        let noSound, overSound;

        // --- Scene Definitions ---

        // SplashScreen Scene
        class SplashScreen extends Phaser.Scene {
            constructor() {
                super('SplashScreen');
            }

            preload() {
                this.load.image('zilla', 'assets/zilla.png');
            }

            create() {
                this.children.each(child => child.destroy());

                let splashScreenImage = this.add.image(this.game.config.width / 2, this.game.config.height / 2, 'zilla');
                let scaleX = this.game.config.width / splashScreenImage.width;
                let scaleY = this.game.config.height / splashScreenImage.height;
                let scale = Math.max(scaleX, scaleY);
                splashScreenImage.setScale(scale);
                
                // Add the @zillaraytorr text at the bottom of the splash screen
                this.add.text(this.game.config.width / 2, this.game.config.height * 0.9, '@zillaraytorr', {
                    fontSize: '48px',
                    fill: '#ff0000', // Bright red color
                    stroke: '#4a0404', // Darker red stroke for a gradient effect
                    strokeThickness: 8,
                    fontStyle: 'bold'
                }).setOrigin(0.5);

                this.time.delayedCall(3000, () => {
                    this.scene.start('MainMenu');
                });
            }
        }

        // MainMenu Scene
        class MainMenu extends Phaser.Scene {
            constructor() {
                super('MainMenu');
                this.highScoreText = [];
            }

            preload() {
                this.load.image('menu_background', 'assets/menu_background.png');
                this.load.image('tutorial', 'assets/tut.png');
            }

            create() {
                this.children.each(child => child.destroy());
                
                let startScreen = this.add.image(this.game.config.width / 2, this.game.config.height / 2, 'menu_background');
                let scaleX = this.game.config.width / startScreen.width;
                let scaleY = this.game.config.height / startScreen.height;
                let scale = Math.max(scaleX, scaleY);
                startScreen.setScale(scale);

                // Re-create the username container if it doesn't exist.
                let usernameContainer = document.getElementById('username-container');
                if (!usernameContainer) {
                    usernameContainer = document.createElement('div');
                    usernameContainer.id = 'username-container';
                    document.body.appendChild(usernameContainer);
                }
                usernameContainer.style.display = 'flex'; // Make sure it's visible

                const usernameInput = document.createElement('input');
                usernameInput.type = 'text';
                usernameInput.placeholder = 'Enter X Username';
                usernameInput.id = 'username-input';
                
                const readyButton = document.createElement('button');
                readyButton.id = 'ready-button';
                readyButton.textContent = 'Ready';

                // Clear any existing children and append new ones
                while (usernameContainer.firstChild) {
                    usernameContainer.removeChild(usernameContainer.firstChild);
                }

                usernameContainer.appendChild(usernameInput);
                usernameContainer.appendChild(readyButton);

                readyButton.onclick = () => {
                    username = usernameInput.value.trim();
                    if (username === '') {
                        usernameInput.style.border = '2px solid red';
                        return;
                    }
                    usernameContainer.style.display = 'none'; // Hide the container instead of removing it
                    this.scene.start('Tutorial');
                };

                // Add High Scores section
                this.add.text(this.game.config.width / 2, this.game.config.height * 0.05, 'TOP 3 HIGH SCORES', { fontSize: '42px', fill: '#FFD700', fontStyle: 'bold' }).setOrigin(0.5);
                this.loadingText = this.add.text(this.game.config.width / 2, this.game.config.height * 0.1, 'Loading High Scores...', { fontSize: '30px', fill: '#ffffff' }).setOrigin(0.5);
                
                const scoreTextStyle = {
                    fontSize: '36px',
                    fill: '#ffffff',
                    fontStyle: 'bold',
                    stroke: '#000000',
                    strokeThickness: 4
                };

                this.highScoreText = [
                    this.add.text(this.game.config.width / 2, this.game.config.height * 0.15, '', scoreTextStyle).setOrigin(0.5),
                    this.add.text(this.game.config.width / 2, this.game.config.height * 0.2, '', scoreTextStyle).setOrigin(0.5),
                    this.add.text(this.game.config.width / 2, this.game.config.height * 0.25, '', scoreTextStyle).setOrigin(0.5)
                ];

                // Subscribe to real-time high score updates
                window.getPublicHighScores((scores) => {
                    highscores = scores; // Update the global highscores array
                    this.loadingText.visible = false; // Hide the loading message
                    this.updateHighScoresDisplay();
                });
            }

            updateHighScoresDisplay() {
                const top3 = highscores.slice(0, 3);
                this.highScoreText.forEach((textObject, index) => {
                    if (top3[index]) {
                        textObject.setText(`${index + 1}. ${top3[index].username}: ${top3[index].score}`);
                    } else {
                        textObject.setText('');
                    }
                });
            }
        }

        // Tutorial Scene
        class Tutorial extends Phaser.Scene {
            constructor() {
                super('Tutorial');
            }

            preload() {
                this.load.image('tutorial', 'assets/tut.png');
            }

            create() {
                this.children.each(child => child.destroy());
                
                let startScreen = this.add.image(this.game.config.width / 2, this.game.config.height / 2, 'tutorial');
                let scaleX = this.game.config.width / startScreen.width;
                let scaleY = this.game.config.height / startScreen.height;
                let scale = Math.max(scaleX, scaleY);
                startScreen.setScale(scale);
                
                // Add the tutorial text
                const headingStyle = {
                    fontSize: '32px',
                    fill: '#FFD700', // Gold color
                    align: 'center',
                    wordWrap: { width: this.game.config.width - 40 },
                    fontStyle: 'bold',
                    stroke: '#000000',
                    strokeThickness: 6
                };
                
                const tutorialStyle = {
                    fontSize: '22px',
                    fill: '#ffffff',
                    align: 'center',
                    wordWrap: { width: this.game.config.width * 0.6 },
                    fontStyle: 'bold',
                    stroke: '#000000',
                    strokeThickness: 4
                };

                // The text is now positioned more tightly together
                this.add.text(this.game.config.width / 2, this.game.config.height * 0.08, 'YOUR MISSION IS TO GET THE HIGHEST SCORE POSSIBLE', headingStyle).setOrigin(0.5);
                this.add.text(this.game.config.width / 2, this.game.config.height * 0.16, 'Tap or swipe to move sideways.', tutorialStyle).setOrigin(0.5);
                this.add.text(this.game.config.width / 2, this.game.config.height * 0.22, 'Eat Peanut Butter and Jelly to raise your Groove. Your Groove constantly drains!', tutorialStyle).setOrigin(0.5);
                this.add.text(this.game.config.width / 2, this.game.config.height * 0.28, 'Avoid Bread to keep your Groove up!', tutorialStyle).setOrigin(0.5);
                
                this.add.text(this.game.config.width / 2, this.game.config.height * 0.38, 'FEVER MODE', headingStyle).setOrigin(0.5);
                this.add.text(this.game.config.width / 2, this.game.config.height * 0.44, 'When your Groove meter reaches 100, you enter Fever Mode. This makes you invincible for a short time and boosts your score!', tutorialStyle).setOrigin(0.5);
                this.add.text(this.game.config.width / 2, this.game.config.height * 0.50, 'Eating Power-ups also gives you instant Fever Mode!', tutorialStyle).setOrigin(0.5);

                this.add.text(this.game.config.width / 2, this.game.config.height * 0.60, 'COMBO IS THE KEY', headingStyle).setOrigin(0.5);
                this.add.text(this.game.config.width / 2, this.game.config.height * 0.66, 'Getting consecutive P&J combos gives you a multiplier! Keep the chain going for bigger scores.', tutorialStyle).setOrigin(0.5);

                this.add.text(this.game.config.width / 2, this.game.config.height * 0.76, 'MAY THE BEST PLAYERS WIN', headingStyle).setOrigin(0.5);
                
                // Add the "GO" button
                const goButton = this.add.text(this.game.config.width / 2, this.game.config.height * 0.84, 'GO', {
                    fontSize: '32px',
                    fill: '#ffffff',
                    backgroundColor: '#00ff00',
                    padding: { x: 20, y: 10 },
                    fontStyle: 'bold'
                }).setOrigin(0.5).setInteractive();

                goButton.on('pointerdown', () => {
                    this.scene.start('VideoIntro');
                });
            }
        }

        // NEW: VideoIntro Scene
        class VideoIntro extends Phaser.Scene {
            constructor() {
                super('VideoIntro');
            }

            preload() {
                // We'll use a placeholder video URL here, you'll need to replace this
                this.load.video('introVideo', 'assets/intro.mp4');
                this.load.audio('music', 'assets/pnut.ogg');
            }

            create() {
                // Destroy all game objects and UI
                this.children.each(child => child.destroy());

                const video = this.add.video(this.game.config.width / 2, this.game.config.height / 2, 'introVideo');
                
                // Scale the video to fit the screen
                let scaleX = this.game.config.width / video.width;
                let scaleY = this.game.config.height / video.height;
                let scale = Math.max(scaleX, scaleY);
                video.setScale(scale);
                
                video.play(true);

                // Start the music when the video plays
                music = this.sound.add('music', { loop: true });
                if (music) music.play();
                
                // Wait 5 seconds for the video to finish, then transition to the game
                this.time.delayedCall(5000, () => {
                    this.scene.start('Game');
                });
            }
        }

        // Game Scene
        class Game extends Phaser.Scene {
            constructor() {
                super('Game');
                this.score = 0;
                this.grooveMeter = 100;
                this.isFeverMode = false;
                this.comboCount = 0;
                this.comboTimer = 0;
                this.currentLane = 1;
                this.OBJECT_SPEED = 700;
                this.baseGameSpeed = 6;
                this.lastSpeedIncreaseScore = 0;
                this.isGrooveLow = false; // Added flag to track if groove is low
            }

            preload() {
                this.load.image('background1', 'assets/background1.png');
                this.load.image('background2', 'assets/background2.png');
                this.load.image('peanut_butter', 'assets/peanut_butter.png');
                this.load.image('jelly', 'assets/jelly.png');
                this.load.image('bread', 'assets/bread.png');
                this.load.image('powerup', 'assets/groove_powerup.png');
                this.load.spritesheet('banana_run', 'assets/banana_run.png', { frameWidth: 128, frameHeight: 469 });
                this.load.audio('fever_sound', 'assets/fever.ogg');
                this.load.audio('good_sound', 'assets/good.ogg'); // New good sound
                this.load.audio('bad_sound', 'assets/bad.ogg'); // New bad sound
                this.load.audio('no_sound', 'assets/no.ogg'); // New sound for low groove
                this.load.audio('over_sound', 'assets/over.ogg'); // New sound for game over
            }

            create() {
                this.score = 0;
                this.grooveMeter = 100;
                this.isFeverMode = false;
                this.comboCount = 0;
                this.comboTimer = 0;
                this.currentLane = 1;
                this.OBJECT_SPEED = 700;
                this.baseGameSpeed = 6;
                this.lastSpeedIncreaseScore = 0;
                this.isGrooveLow = false; // Reset the flag
                
                // Two copies of the same background image are created for the scrolling effect
                this.bg1 = this.add.image(this.game.config.width / 2, this.game.config.height / 2, 'background1');
                this.bg2 = this.add.image(this.game.config.width / 2, this.game.config.height / 2, 'background1');
                
                // Calculate the scaling factor and apply it to both backgrounds
                let scaleX = this.game.config.width / this.bg1.width;
                let scaleY = this.game.config.height / this.bg1.height;
                let scale = Math.max(scaleX, scaleY);
                this.bg1.setScale(scale);
                this.bg2.setScale(scale);
                
                // Position the second background directly above the first one to start
                this.bg1.y = -this.bg1.displayHeight / 2;
                this.bg2.y = this.bg1.y + this.bg2.displayHeight;

                // Create the banana player character with a responsive position
                this.player = this.physics.add.sprite(this.game.config.width / 2, this.game.config.height * 0.96, 'banana_run');
                this.player.body.allowGravity = false;
                this.player.setScale(0.99);
                this.player.setOrigin(0.5, 0.9); // Set the origin to the bottom of the banana
                this.player.setCircle(this.player.width / 2, 0, this.player.height * 0.4); // Adjust bounding box

                this.anims.create({
                    key: 'run',
                    frames: this.anims.generateFrameNumbers('banana_run', { start: 0, end: 3 }),
                    frameRate: 9.7,
                    repeat: -1
                });
                
                this.player.play('run');

                this.lanePositions = [
                    this.game.config.width * 0.25,
                    this.game.config.width * 0.5,
                    this.game.config.width * 0.75
                ];
                
                // Create groups for objects
                this.objects = this.physics.add.group();
                this.powerups = this.physics.add.group();

                // Set up the HUD with responsive positions
                this.scoreText = this.add.text(this.game.config.width * 0.02, this.game.config.height * 0.02, 'Score: 0', { fontSize: '24px', fill: '#ffffff', fontStyle: 'bold' });
                this.grooveText = this.add.text(this.game.config.width * 0.02, this.game.config.height * 0.06, 'Groove: 100%', { fontSize: '24px', fill: '#ffffff', fontStyle: 'bold' });
                this.comboText = this.add.text(this.game.config.width / 2, this.game.config.height * 0.15, '', { fontSize: '28px', fill: '#ff8c00', fontStyle: 'bold' }).setOrigin(0.5);
                this.feverText = this.add.text(this.game.config.width / 2, this.game.config.height * 0.12, 'FEVER MODE!', { fontSize: '28px', fill: '#ffff00', fontStyle: 'bold' }).setOrigin(0.5);
                this.feverText.visible = false;

                this.grooveBar = this.add.graphics();

                // Get the top score and the current user's highest score
                const topScore = highscores[0] ? highscores[0] : { username: 'N/A', score: 0 };
                const userScores = highscores.filter(score => score.username === username);
                const userHighScore = userScores.length > 0 ? userScores.reduce((max, current) => (current.score > max.score ? current : max)).score : 0;

                // Display Top 1 High Score
                this.topScoreText = this.add.text(this.game.config.width * 0.98, this.game.config.height * 0.02, `Top 1 - ${topScore.username}: ${topScore.score}`, {
                    fontSize: '20px',
                    fill: '#ffc107',
                    align: 'right',
                    fontStyle: 'bold'
                }).setOrigin(1, 0);

                // Display Current Player's High Score
                this.userScoreText = this.add.text(this.game.config.width * 0.98, this.game.config.height * 0.05, `You - ${username}: ${userHighScore}`, {
                    fontSize: '20px',
                    fill: '#ffffff',
                    align: 'right',
                    fontStyle: 'bold'
                }).setOrigin(1, 0);

                // Create the Pause and Play buttons with responsive positions
                const pauseButton = this.add.text(this.game.config.width * 0.9, this.game.config.height * 0.08, 'Pause', {
                    fontSize: '16px',
                    fill: '#ffffff',
                    backgroundColor: '#FF0000',
                    padding: { x: 10, y: 5 }
                }).setOrigin(0, 0).setInteractive();

                const playButton = this.add.text(this.game.config.width * 0.9, this.game.config.height * 0.08, 'Play', {
                    fontSize: '16px',
                    fill: '#ffffff',
                    backgroundColor: '#00FF00',
                    padding: { x: 10, y: 5 }
                }).setOrigin(0, 0).setInteractive().setVisible(false);

                // Increased button size
                const buttonWidth = 90;
                const buttonHeight = 37.5;
                pauseButton.setFixedSize(buttonWidth, buttonHeight);
                playButton.setFixedSize(buttonWidth, buttonHeight);

                pauseButton.on('pointerdown', () => {
                    pauseButton.setVisible(false);
                    playButton.setVisible(true);
                    music?.pause();
                    this.physics.pause();
                    this.player.anims.pause();
                    if (this.objectSpawnTimer) {
                        this.objectSpawnTimer.paused = true;
                    }
                });

                playButton.on('pointerdown', () => {
                    playButton.disableInteractive();
                    let countdown = 3;
                    const countdownText = this.add.text(this.game.config.width / 2, this.game.config.height / 2, countdown, { fontSize: '100px', fill: '#ffffff' }).setOrigin(0.5);
                    
                    const countdownTimer = this.time.addEvent({
                        delay: 1000,
                        callback: () => {
                            countdown--;
                            if (countdown > 0) {
                                countdownText.setText(countdown);
                            } else {
                                countdownText.destroy();
                                playButton.setInteractive();
                                playButton.setVisible(false);
                                pauseButton.setVisible(true);
                                music?.resume();
                                this.physics.resume();
                                this.player.anims.resume();
                                if (this.objectSpawnTimer) {
                                    this.objectSpawnTimer.paused = false;
                                }
                                countdownTimer.remove();
                            }
                        },
                        loop: true
                    });
                });
                
                // Set up swipe input controls
                this.input.on('pointerdown', (pointer) => {
                    if (!this.physics.world.isPaused) {
                        this.startX = pointer.x;
                    }
                });

                this.input.on('pointerup', (pointer) => {
                    if (!this.physics.world.isPaused) {
                        const swipeThreshold = 50;
                        const swipeDistance = pointer.x - this.startX;

                        if (swipeDistance > swipeThreshold && this.currentLane < 2) {
                            this.currentLane++;
                        } else if (swipeDistance < -swipeThreshold && this.currentLane > 0) {
                            this.currentLane--;
                        }
                    }
                });

                // Set a timer to spawn objects on a beat
                this.objectSpawnTimer = this.time.addEvent({
                    delay: 500, // SPAWN_INTERVAL
                    callback: this.spawnObject,
                    callbackScope: this,
                    loop: true
                });
                
                // Add collision detection
                this.physics.add.overlap(this.player, this.objects, this.collectObject, null, this);
                this.physics.add.overlap(this.player, this.powerups, this.collectPowerup, null, this);

                // Set up sounds
                feverSound = this.sound.add('fever_sound');
                goodSound = this.sound.add('good_sound');
                badSound = this.sound.add('bad_sound');
                noSound = this.sound.add('no_sound'); // Initialize new sound
                overSound = this.sound.add('over_sound'); // Initialize new sound
            }

            update () {
                if (!this.physics.world.isPaused) {
                    // Move the backgrounds
                    let gameSpeed = this.isFeverMode ? this.baseGameSpeed * 2 : this.baseGameSpeed;
                    this.bg1.y += gameSpeed;
                    this.bg2.y += gameSpeed;

                    // Drain groove meter
                    if (!this.isFeverMode) {
                        this.grooveMeter -= 0.05;
                        
                        // Check if groove is low to play 'no' sound
                        if (this.grooveMeter < 50 && !this.isGrooveLow) {
                            this.isGrooveLow = true;
                            noSound?.play();
                        } else if (this.grooveMeter >= 50 && this.isGrooveLow) {
                            this.isGrooveLow = false;
                        }

                        if (this.grooveMeter <= 0) {
                            this.grooveMeter = 0;
                            this.scene.start('GameOver', { score: this.score, username: username });
                        }
                    }

                    // Increase speed every 250 points
                    if (this.score > 0 && Math.floor(this.score / 250) > Math.floor(this.lastSpeedIncreaseScore / 250)) {
                        this.OBJECT_SPEED *= 1.1;
                        this.baseGameSpeed *= 1.1;
                        this.lastSpeedIncreaseScore = this.score;
                    }

                    // The backgrounds will be moved manually now that they are images
                    if (this.bg1.y > this.game.config.height + this.bg1.displayHeight / 2) {
                        this.bg1.y = this.bg2.y - this.bg2.displayHeight;
                    }
                    if (this.bg2.y > this.game.config.height + this.bg2.displayHeight / 2) {
                        this.bg2.y = this.bg1.y - this.bg1.displayHeight;
                    }
                    
                    // Smoothly move the banana to the center of its current lane
                    let targetX = this.lanePositions[this.currentLane];
                    if (this.player.x !== targetX) {
                        this.player.x = Phaser.Math.Interpolation.Linear([this.player.x, targetX], 0.1);
                    }

                    // Reset combo if a certain time has passed
                    if (this.comboCount > 0 && this.time.now - this.comboTimer > 1000) {
                        this.comboCount = 0;
                    }
                }
                
                // Update the HUD display outside the pause check so it always reflects the current state
                this.scoreText.setText('Score: ' + this.score);
                this.grooveText.setText('Groove: ' + Math.floor(this.grooveMeter) + '%');
                this.comboText.setText(this.comboCount > 1 ? 'Combo x' + this.comboCount : '');
                this.feverText.visible = this.isFeverMode;

                // Update the Groove Bar
                this.grooveBar.clear();
                let barColor = this.isFeverMode ? 0xffff00 : (this.grooveMeter < 50 ? 0xff0000 : 0x00ff00);
                this.grooveBar.fillStyle(barColor, 1);
                this.grooveBar.fillRect(this.game.config.width * 0.02, this.game.config.height * 0.09, (this.grooveMeter / 100) * 225, 22.5);
                this.grooveBar.lineStyle(2, 0xffffff, 1);
                this.grooveBar.strokeRect(this.game.config.width * 0.02, this.game.config.height * 0.09, 225, 22.5);
            }
            
            spawnObject() {
                let lane = Phaser.Math.Between(0, 2);
                let x = this.lanePositions[lane];
                let y = -50;
                
                // Get the current speed, which doubles in fever mode
                let currentObjectSpeed = this.isFeverMode ? this.OBJECT_SPEED * 2 : this.OBJECT_SPEED;

                if (Phaser.Math.Between(1, 10) === 1) {
                    let powerup = this.powerups.create(x, y, 'powerup');
                    powerup.setScale(0.255);
                    powerup.setCircle(powerup.width * 0.5, 0, 0);
                    powerup.setVelocityY(currentObjectSpeed);
                } else {
                    let objectType = Phaser.Math.Between(0, 2);
                    let imageKey = ['peanut_butter', 'jelly', 'bread'][objectType];
                    let object = this.objects.create(x, y, imageKey);
                    object.setScale(0.255);
                    object.setCircle(object.width * 0.5, 0, 0);
                    object.setVelocityY(currentObjectSpeed);
                }
            }
            
            collectObject(player, object) {
                object.destroy();
                let type = object.texture.key;
                
                if (type === 'bread') {
                    if (!this.isFeverMode) {
                        this.grooveMeter -= 25;
                        this.comboCount = 0;
                    }
                    badSound?.play();
                } else {
                    this.comboCount++;
                    this.score += 10 * this.comboCount;
                    if (this.isFeverMode) {
                        this.score += 10;
                    }
                    this.grooveMeter += 5;
                    if (this.grooveMeter > 100) {
                        this.grooveMeter = 100;
                        if (!this.isFeverMode) {
                            this.isFeverMode = true;
                            feverSound?.play();
                            this.time.addEvent({
                                delay: 5000,
                                callback: () => {
                                    this.isFeverMode = false;
                                    this.grooveMeter = 78;
                                },
                                loop: false
                            });
                        }
                    }
                    goodSound?.play();
                }
                this.comboTimer = this.time.now;
            }

            collectPowerup(player, powerup) {
                powerup.destroy();
                this.grooveMeter = 100;
                if (!this.isFeverMode) {
                    this.isFeverMode = true;
                    feverSound?.play();
                    this.time.addEvent({
                        delay: 5000,
                        callback: () => {
                            this.isFeverMode = false;
                            this.grooveMeter = 78;
                        },
                        loop: false
                    });
                }
            }
        }

        // GameOver Scene
        class GameOver extends Phaser.Scene {
            constructor() {
                super('GameOver');
            }

            init(data) {
                this.finalScore = data.score;
                this.username = data.username;

                // Save score to Firestore
                if (window.savePublicScore) {
                    window.savePublicScore(this.username, this.finalScore);
                }
            }

            preload() {
                this.load.image('game_over', 'assets/game_over.png');
            }

            create() {
                music?.stop();
                feverSound?.stop();
                overSound?.play(); // Play 'over' sound on the game over screen
                
                // Destroy all game objects and UI
                this.children.each(child => child.destroy());
                
                // Display game over screen with bold text
                this.add.image(this.game.config.width / 2, this.game.config.height / 2, 'game_over');
                this.add.text(this.game.config.width / 2, this.game.config.height * 0.25, 'GAME OVER', { fontSize: '48px', fill: '#ff0000', fontStyle: 'bold' }).setOrigin(0.5);
                this.add.text(this.game.config.width / 2, this.game.config.height * 0.35, `Final Score: ${this.finalScore}`, { fontSize: '32px', fill: '#ffffff', fontStyle: 'bold' }).setOrigin(0.5);
                this.add.text(this.game.config.width / 2, this.game.config.height * 0.4, `Player: ${this.username}`, { fontSize: '24px', fill: '#ffffff', fontStyle: 'bold' }).setOrigin(0.5);
                
                // Play again button with bold text
                const playAgainButton = this.add.text(this.game.config.width / 2, this.game.config.height * 0.55, 'PLAY AGAIN', {
                    fontSize: '28px',
                    fill: '#ffffff',
                    backgroundColor: '#00ff00',
                    padding: { x: 20, y: 10 },
                    fontStyle: 'bold'
                }).setOrigin(0.5).setInteractive();

                playAgainButton.on('pointerdown', () => {
                    this.scene.start('MainMenu');
                });
            }
        }

        // --- Game Configuration ---
        const config = {
            type: Phaser.AUTO,
            width: 720,
            height: 1280,
            parent: 'game-container',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            },
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH,
            },
            scene: [SplashScreen, MainMenu, Tutorial, VideoIntro, Game, GameOver]
        };

        window.onload = function() {
            // First, initialize Firebase and authenticate the user.
            // This is a crucial step to ensure the database is ready before the game starts.
            window.initializeFirebase().then(() => {
                new Phaser.Game(config);
            }).catch(error => {
                console.error("Failed to start game due to Firebase error:", error);
            });
        };
    </script>
</body>
</html>
